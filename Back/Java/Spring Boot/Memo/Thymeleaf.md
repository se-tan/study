# What is Thymeleaf ?

ThymeleafはWebアプリケーションと親和性の高いテンプレートエンジン。  
テンプレートエンジンとは、ひな型となるドキュメントに対し、可変データを埋め込むことで動的にドキュメントを作成する仕組み。

ThymeleafはテンプレートをXHTMLやHTML5に準拠した形で記述できること。

## ■ JSPとの違い

JSPはブラウザが認識できないタグライブラリなどが含まれるため、開発中のJSPを直接ブラウザ上で正確に表示させることが難しいという問題があった。  
ThymeleafはHTML5に準拠しているため、デザイナーとプログラマ間での共有が容易になる。

***

## ■ Thymeleaf のテンプレート

### - **仕組み**

Thymeleafは、XHTMLやHTML5などで書かれたテンプレートをDOMに変換してから処理を行う仕組みになっており、  
「処理対象のDOMノード」と「DOMノードに適用する処理」を ***th*** ネームスペースの属性(th属性)を使用して指定する。

th属性が指定されているDOMノードは、「プロセッサ」と呼ばれるコンポーネントによってDOM操作(追加、削除、変更)が行なわれる。  
th属性の属性値には、OGNL(Object-Graph Navigation Language)という式言語を指定でき、  
式の中からは、ユーザー定義のオブジェクトやThymeleafが提供する暗黙オブジェクトにアクセスすることができる。

<br>

### - **Dialect**

Thymeleafでは、「DOM操作を行うプロセッサ」「th属性の属性値に指定された式を解釈するコンポーネント」「暗黙オブジェクトを生成するコンポ―ネント」などを総称して「***Dialect***」と呼び、デフォルトだとStandardDialectクラスが使用される。

Dialectは拡張可能な仕組みになっており、例えばThymeleaf-spring4を使う場合は、SpringStandradDialectクラスを使用する。

***

## ■ テキストの出力

- th:text  
  属性値に指定した値をXHTMLサニタイジングして出力する

- th:utext  
  属性値に指定した値をXHTMLサニタイジングせずに出力する

> *Tips:似たような言葉の違い*  
> サニタイジング：意図しない動作を防ぐため、文字が持つ特別な意味を「**無害化**」する処理  
> エスケープ処理：サニタイジングするための手段の1つで、プログラム上使用できない記号、特殊文字を適切な文字列に置換する  
> バリデーション：入力されたデータの妥当性確認

***

## ■ 式の構文

### - **基本的な式**

| 名称         | 例                         | 意味                                                                                                       |
| ------------ | -------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 変数式       | ${user.name}               | Thymeleafが管理する様々な変数へアクセスしたりメソッドを実行できる。Modelに格納された情報へのアクセスも可能 |
| 選択変数式   | *{name}                    | 特定オブジェクトに対するプロパティを連続してアクセスしたいときに使用                                       |
| メッセージ式 | #{status.reserved.message} | メッセージをkey-valueで管理できるため、key値から本文を解決する場合に使用                                   |
| リンクURL式  | @{/echo}                   | 指定したURLの先頭にコンテキストパスを指定できる                                                            |

<br>

### - **利用可能なリテラル**

- テキストリテラル

- 数値リテラル

- 真偽値リテラル

- Nullリテラル

- リテラルトークン

<br>

### - **基本的な演算子**

- 算術演算子
  
- 論理演算子

- マイナス符号

- 比較演算：<や>などは文字列エイリアス(gt、ltなど)が用意されている
  
<br>

### - **テキスト演算子**

- テキスト追加：`th:text="'My name is ' + ${username}."`

- リテラル置換：`th:text="|My name is ${username}.|"`

リテラル置換をすると、テキストリテラル内に置換変数(${変数名})を設けることができ、可読性を保ちやすい特徴がある。

<br>

### - **条件演算子**

- 三項演算子：`th:text="${row.even}? 'even' : 'odd'"`

- エルビス演算子：`th:text="${username}?: 'Sam Smith'"`

***

## ■ th属性による属性値の設定

| 設定処理                             | 説明                                                                                           |
| ------------------------------------ | ---------------------------------------------------------------------------------------------- |
| 特定属性に値を設定                   | HTMLの各属性に対して専用のth属性が用意されており、可読性が高くわかりやすいので最もよく使われる |
| 現在の属性値の前後に値を追加         | 動的に変化する属性の一部をテンプレート化するときに使用される                                   |
| 存在有無が重要な属性の出力を制御する | checked/readonly属性等、属性の存在有無が重要なものに、その属性自体の出力有無を制御する         |
| 複数の属性に同じ値を設定             | alt/title属性といった同じ値を設定することが一般的な属性に対して専用の設定方法がある            |
| 任意の属性に値を設定                 | th:attr属性を使用し、任意の属性に値を設定するが、可読性低下を招くのであまり使われない          |

以下順番に説明の詳細を記載

<br>

### - **特定の属性に値を設定する方法**

`th:href`、`th:action`、`th:value`、`th:form`、`th:id`など、基本的に属性名の先頭にthを付けて指定する。

```html
<a href="./echo/input.html" th:href="@{/echo}">エコーアプリケーション</a>
```

<br>

### - **現在のゾック聖地の前後に値を追加する方法**

class属性のように複数の値が設定可能な場合、現在設定されている値の前または後ろに値を追加したいケースがある。  
その場合、`th:classappend`属性のように属性値を追加する専用のth属性を利用できる。

- `th:classappend`：class属性の専用であり、現在の設定値の後ろに値を追加する

- `th:styleappend`：style属性の専用であり、現在の設定値の後ろに値を追加する

```html
<input type="button" value="登録" class="btn" th:classappend="${cssStyle}" />
```

<br>

### - **存在有無が重要な属性の出力を制御する方法**

selected属性やreadonly属性などの、属性自体は自明であり、属性が存在するかどうかに意味がある属性は、属性値を動的に変化させるのではなく、  
属性の有無を動的に変化させる必要がある。

Thymeleafでは、属性自体の出力を動的に制御することのできるth属性を対象をなり得る属性ごとに用意している。

```html
<input type="checkbox" name="understand" th:checked="${info.understand}" />
```

<br>

### - **複数の属性に同じ値を設定する方法**

alt属性とtitle属性などでは、同じ値を設定するのが一般的。

- `th:alt-title`属性：th:alt属性とth:title属性を同時に適用する

- `th:lang-xmllang`属性：th:lang属性とth:xmllang属性を同時に適用する

```html
<img src="../images/sample.jpg" th:src="@{/images/sample.jpg}" th:alt-title="#{info}" />
```

<br>

### - **任意の属性に値を設定する方法**

th:attr属性を利用することで、任意の属性に値を設定できる。

```html
<button th:attr="data-product-id=${product.id}">削除</button>
```

***

## ■ HTML要素の出力制御

### - **条件による出力有無の制御**

Thymeleafには、式の評価結果が真の場合のみHTML要素を出力する、といったような出力有無を制御することができるth属性が提供されている。

- `th:if`：属性値が真の場合のみ対象となるHTML要素を出力する

- `th:unless`：属性値が偽の場合のみ対象となるHTML要素を出力する

- `th:switch`：子要素に記述された`th:case`属性の値と比較評価を行うための値を設定する

- `th:case`：親要素の`th:switch`属性の値と等しい場合のみ対象となるHTML要素を出力する

また、属性内に指定した式によって評価された値がboolean型以外の場合は、以下のように真偽を判断する。

- nullは偽

- 数値型：0以外なら真、0なら偽

- 文字列型：false, off, noなら偽、それ以外は真

- boolean型、数値型、文字列型以外は常に真

<br>

### - **繰り返し出力の制御**

指定された配列値の数だけHTML要素を繰り返し出力する、といったような制御ができる`th:each`が提供されている。  
以下**配列相当の型である必要がある**。

- `java.util.List`の実装クラス

- `java.util.Iterable`の実装クラス

- `java.util.Map`の実装クラス

- 配列

取得可能なメタ情報は以下の通り。

| プロパティ | 説明                                         |
| ---------- | -------------------------------------------- |
| index      | 繰り返しインデックス(0から開始)              |
| count      | 繰り返しインデックス(1から開始)              |
| size       | 対象の総件数                                 |
| current    | 現在の繰り返し処理で扱っている要素値         |
| odd        | 現在の繰り返し処理が奇数であるかを示す真偽値 |
| even       | 現在の繰り返し処理が偶数であるかを示す真偽値 |
| first      | 現在の繰り返し処理が最初であるかを示す真偽値 |
| last       | 現在の繰り返し処理が最後であるかを示す真偽値 |

<br>

```html
<h2>繰り返し</h2>
<table>
    <tr>
        <th>No</th><th>名前</th><th>価格</th><th>在庫</th>
    </tr>
    <tr th:each="prod : ${products}">
        <td th:text="${prodStat.count}">1</td>
        <td th:text="${prod.name}">Tomato</td>
        <td th:text="${prod.price}">498</td>
        <td th:text="${prod.stock == 0 ? '売り切れ' :prod.stck}">10</td>
    </tr>
</table>
```

***

## ■ インライン記述

Thymeleafのth属性を利用しない記述方法。[[....]]の表記で記述する。

`<p>Hello, [[${user.name}]]!</p>`

以下のコードは上記コードと同じ(th属性を使用)

`<p>Hello, <span th:text="${user.name}"></span>!</p>`
