## Kubernetesオブジェクト
Kubernetesでは、コンテナやネットワーク、ストレージなどの構成要素を「リソース(Resource)」と呼び、それぞれを「Kubernetesオブジェクト」として表現する。  
こうしたオブジェクトは、マスターノードのetcdに格納されている。コンテナを作りたいときは、そのコンテナに相当するオブジェクトとして表現し、  
それをKube-apiserverに投げると、Kubernetesクラウド上にコンテナができるという仕組み。

## 「望ましい状態」に合うように調整される
オブジェクトはすべてetcdにあり、そこには管理者が設定した状態が格納されている。管理者が設定した状態のことを「望ましい状態」という。  
Kubernetesは望ましい状態と合わないときは、合うように調整してくれる。　
>> 「望ましい状態」としてコンテナに相当するオブジェクトがあるが、Kubernetesクラスター上にはそのコンテナが存在しない場合、Kubernetesはそのコンテナを作成する

このように「望ましい状態」と「現在の状態」を比較して、望ましい状態に合うように調整するのが、Kubernetesの基本的な動作。  
言い換えると、*ワーカーノード上で動いているコンテナやネットワーク、ストレージに対して、管理者が、何か直接、手を下すことはできないということ。*

## 代表的なKubernetesオブジェクト
### 1. Podオブジェクト
Kubernetesにおける最小実行単位。1つ以上のコンテナ、いくつかのボリューム(ストレージ)を含むことができる。  
コンテナ間のデータ共有に使用でき、必ずいずれかのワーカーノード上で実行され、分割されることはない。
* プライベートIPアドレスの共有  
    Podには、1つの動的なプライベートIPアドレスが割り当てられ、含まれるコンテナは、そのIPアドレスを共有して、他のPodと通信できる。  
    → (1) 含まれているコンテナ同士がlocalhost上で通信できる  
      (2) 含まれているコンテナ同士で同じポート番号は競合するため利用できない

* Pod内のボリュームは失われる可能性がある  
    Podは永続的ではない。マスターノードに正常に稼働していないと判断されると、そのPodは終了させられ、別のPodが新たに起動する。  
    そのため、ボリュームは失われ、IPアドレスも変化してしまう。さらに別のワーカーノード上で実行される可能性もある。

### Serviceオブジェクト
配下に同一構成のPodを束ねる概念のこと。同じ構成のPodを「レプリカ(replica)」という。  
serviceに対しては作成時に固定されたIPアドレスが割り当てられ、これを「Cluster IP」といい、Serviceを明示的に削除しない限りイミュータブルな値となっている。　
Cluster IPで要求を受信し、それを配下のPodへと振り分けるもので、技術的には、プロキシやNATなどの仕組みを用いたロードバランサーに相当する。  
Serviceはワーカーノードをまたぐ概念であり、ワーカーノードが異なっていても、1つのIPアドレスでアクセスできる。

* Serviceの名前とDNS  
    Serviceには名前(name)を設定できる。Kubernetesには、既定で「CoreDNS」と呼ばれるDNSサービスが動作しており、  
    Serviceの名前とCluster IPアドレスとの関係が設定される。  
    クラスター内で実行されるコンテナは、既定でこのDNSサービスを使うよう構成されているため、Service名を使ってServiceに対して通信ができる。

* ヘッドレスサービス  
    Serviceには「プロキシがない」という選択肢がある。ServiceにCluster IPを設定しないことで実現する(このServiceを「ヘッドレスサービス」という)。  
    ヘッドレスサービスとして構成すると、Serviceに対して設定した名前をDNSで検索した時に、その配下に存在するPodのプライベートIPアドレスがすべて一覧で返される。  
    これらのIPアドレスを使って直接通信するのが、ヘッドレスサービス。

### ラベルとセレクターによるオブジェクトの選択
Serviceの配下には、Podを配置するが、その配置するPodを指定するものに、セレクターというものが存在する。
1. オブジェクトに対するラベル  
    すべてのKubernetesオブジェクトには、任意のラベル(Label)を付けられる。これはキーと値のペアで以下のように記述する。
    ```
    metadata:
        labels:
            mygroup: myapp
    ```

2. セレクター  
    ラベルは、「値が合致する」または「値が含まれる」という条件で、オブジェクトを絞り込むことができ、この機能を「セレクター(Selector)」という。
    ```
    selector:
        matchLabels:
            mygroup: myapp
    ```

3. 様々な場面で使用されるセレクター  
    ボリュームの選択やPodのテンプレートを選択するときなど。様々なグルーピングをしたいときに利用される。

### Serviceの外部への公開
Serviceの名前を利用してKubernetesクラスター外からServiceに向けては通信することができない。  
Cluster IPやPodのIPアドレスは、Kubernetesクラスター内でのみ有効。そのためこのプライベートなIPアドレスをグローバルIPアドレスに変換する必要がある。

1. ワーカーノードを使う  
    ワーカノードのIPアドレスを通じて通信する方法。Serviceオブジェクトを構成するときに、NodePortという設定を追加する。　
    →docker runにおける-pオプションと同じ  
    ただしワーカーノード単位で分断されるので、どのワーカーノードに接続するか決めなくてはいけない問題点がある。

2. Serviceの前段にロードバランサーを構成する  
    Serviceオブジェクトに対してLoadBalancerオプションを構成すると、前段にグローバルIPアドレスを設定したロードバランサーを構成できる。  
    TCP・UDPを使った通信ではこの方法が一般的。

3. Ingressオブジェクトを使う方法  
    Ingressオブジェクトは、HTTP/HTTPS専用のアプリケーションレイヤーで動作するリバースプロキシ。  

    >>プロキシはクライアント側のパシリ  
    リバースプロキシはサーバー側のパシリ
    
    このオブジェクトをServiceの前段に明示的に設置することで、Serviceへと通信を行う。  
    2.との違いはURLのパスの違いによって、別のサーバーに振り分けるような構成ができる。  
    → http://hostname/foo/はワーカーノードA、http://hostname/bar/はワーカーノードBへつながる　　
    
