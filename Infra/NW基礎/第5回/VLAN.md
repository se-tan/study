# VLAN (Virtual LAN)

## 概要
物理的な接続形態とは独立して、***仮想的なLANセグメントをつくる技術***のこと。  
スイッチ内部に論理的にLANセグメントを分割するために使用される。ルータやL3スイッチと同様に***ブロードキャストドメインの分割***が可能。

***

## 特徴
### 1. ブロードキャストドメインの分割
ARPリクエストの等の無駄な受信フレームが減り、各ホストの無駄なCPU処理を軽減できる。

### 2. 物理配置にとらわれないセグメント化
異なるフロアのスイッチ間の接続でもブロードキャストを分割できる。

### 3. セキュリティの向上
VLANを設定すると同じVLAN IDのポートにのみブロードキャストが転送され、異なるVLAN IDのポートに転送されない。  
VLAN ID単位でトラフィックを分離することができるのでNWセキュリティが向上する。

***

## Catalystスイッチの用語
### 1. デフォルトVLAN
Catalystスイッチは、出荷時のデフォルト状態では全てのスイッチポートで**VLAN 1**が設定されている。  
全てのポートで同じVLAN IDが割り当てられているので、初期状態では1つのブロードキャストドメインとなる。

### 2. 管理VLAN
Catalystスイッチを管理するための管理用トラフィックを流すVLANのこと。デフォルトでVLAN 1が設定されている。  
管理VLAN用に用意された**管理インターフェース**にIPアドレスを割り当てることにより、  
Catalystスイッチに対し、telnetアクセスしたりSNMPにより監視することができる。

***

## アクセスポート
1つのVLANだけに所属するポートのこと。コンピュータなどのデバイスは1つのNWに所属する為アクセスポートを使用する。  
このアクセスポートの設定方法には2種類ある。

### 1. スタティックVLAN
スイッチポートに管理者が主導でVLANを割り当てる方法。設定が簡単であるというメリットがある。

### 2. ダイナミックVLAN
接続するデバイスによってポートが動的に所属するVLANを変更できるVLAN。  
接続するデバイスのMACアドレスで決定する**MACベースVLAN**、IPアドレスで決定する**サブネットベースVLAN**、  
ユーザ名などの情報に基づいて決定する**ユーザベースVLAN**など、大きく3種類ある。


## トランクポート
複数のVLANに所属するポート。主にスイッチ同士を接続する際に使用するポート。  
1本の物理リンクで複数のVLANトラフィックを伝送できるようにする。このリンクを**トランクリンク**という。  
どのVLANトラフィックなのかを識別するために*タグ*をつける。

### トランキングプロトコル
トランクリンクでタグを付与するプロトコルには***IEEE802.1Q***と***ISL***の2つがある。  
IEEE802.1Qでは送信元MACアドレスとタイプフィールドの間にタグと呼ばれる4byteのフィールドを挿入する。  
2byteのTPID(Tag Protocol Identifier)と2byteのTCI(Tag Control Information)により構成される。  

>IEEE802.1Q  
    IEEE802.1Qトランクでは***ネイティブVLAN***というトランクリンクでタグを付与せず転送するVLANがある。  
    タグなしフレームを受信したスイッチは、ネイティブVLANからのトラフィックとして認識することから、  
    トランクリンクの両端でネイティブVLANのIDを同じ値にする必要がある。

>ISL (Inter-Switch Link)  
    Cisco独自のトランキングプロトコル。IEEE802.1Qではイーサネットフレームの挿入を行なうが、  
    ISLではイーサネットフレームへのISLヘッダとFCSを付加しカプセル化する。

***

## VLANの作成
`(config) # vlan` *[vlan-id]*  
`(config-vlan) # name` *[vlan-name]*

>削除する場合は頭に「no」をつける

### スイッチポートのモード設定
`(config-if) # switchport mode` *[access|trunk|dynamic-desirable|dynamic-auto]*  

***DTP***(Dynamic Trunking Protocol)は、スイッチポートをアクセスポートまたはトランクポートにするのかを動的に決定するCisco独自のプロトコル。  
対向のスイッチポートの設定状況に応じて自身のスイッチポートをアクセスポートまたはトランクポートで動作する。  

>トランクポートでのDTP送信の停止  
`(config-if)# switchport nonegtiate`

### スイッチポートのモード設定(アクセスポート)
`(config-if)# switchport mode access`  
`(config-if)# switchport access vlan` *[vlan-id]*

### スイッチポートのモード設定(トランクポート)
`(config-if)# switchport mode trunk`  

* トランキングプロトコルの設定  
    `(config-if)# switchport trunk encapsulation` *[dot1q|isl]*

* ネイティブVLANの設定  
    `(config-if)# switchport trunk vlan` *[vlan-id]*

* allowed VLANの設定(不要なVLANトラフィックの転送防止のための設定)  
    `(config-if)# switchport trunk allowed vlan` *[vlan-id]*

***

## VTP (VLAN Trunking Protocol)
トランクポートから***VTPアドバタイズメント***と呼ばれるメッセージを送信して、  
スイッチNW全体で設定されているVLAN情報の同期を取るCisco独自のプロトコル。  
これを利用することで、管理者は1台のスイッチに対してVLANの追加、名前変更、削除などを行うだけで、  
同じグループ(同じVTPドメイン)の全てのスイッチにVLANの追加、変更、削除の情報が通知される。  

>VTPアドバタイズメントはトランクポートでのみ伝搬されるため、スイッチ間の接続はトランクポートにする必要がある。  
トランキングプロトコルはdot1qとislの両方をサポートしている。  
VTPによる同期の前提はVTPドメインが同じであること。Catalystスイッチは1つのVTPドメインしか参加できない。

### 3つのモード
1. サーバ  
    VLANの作成、変更、削除ができる。VLAN情報は、VTPアドバタイズメントで通知される。  
    VTPアドバタイズメントを受信すると、同期を行い、他のスイッチへ転送する。

2. クライアント  
    VLANの削除、変更、追加はできない。VTPアドバタイズメントの通知もしない。  
    ただし、VTPアドバタイズメントを受信すると、同期を行ない、他のスイッチへ転送する。

3. トランスペアレント  
    VLANの作成、変更、削除ができる。ただしVLAN情報は、VTPアドバタイズメントで通知しない。  
    VTPアドバタイズメントを受信しても、同期しないが他のスイッチへは転送する。


### コンフィグレーションリビジョン番号
VTPアドバタイズメントはトランクポートからデフォルトで***300秒ごとに送信***される。  
またはサーバモードのスイッチでVLAN情報が変更された時点でネイティブVLANから送信される。  
VTPアドバタイズメントはVTPドメイン、VTPパスワード、VLAN情報、コンフィグレーションリビジョン番号を含む。  

コンフィグレーションリビジョン番号は、VTPアドバタイズメントで通知されたVLAN情報が最新であるかを確認するための情報。初期値0。  
サーバモードのスイッチがVLAN設定を変更する度に値が1増える。  

>VTPサーバーやクライアントのスイッチは、リビジョン番号を見てVLAN情報を更新するかどうか決めている。

### VTPプルーニング
トランクリンク上で不要なVLANトラフィックの伝送を止める機能。  
これにより動的なallowed VLANと同等の機能を提供することから、管理者が手動で設定変更することがなく、  
無駄なVLANトラフィックをなくすことができる。

### VTPドメインの設定
`(config)# vtp domain` *[domain-name]*

### VTPモードの設定
VTPモードのデフォルトは***Server***。VTP機能を利用しない場合は***Transparent***にする。  
`(config)# vtp mode` *[server|client|transparent]*

### VTPプルーニングの設定
`(config)# vtp pruning`

***

## VLANルーティング
L2スイッチはVLANでブロードキャストドメインを分割できるが、セグメント内のルーティングはできない。  
1台のL2スイッチだけではVLANで分離したセグメント間をルーティングできないが、ルータを介せば通信可能になる。
  
1つの物理リンク上で複数のVLANを伝送できるトランクポートを利用するとき、  
スイッチポートではトランクポートはサポートしているが、ルータではサポートしていない。  
そこでルータでは代わりに**サブインターフェース**を利用する。

>サブインターフェース  
ルータの物理インターフェースを論理的に分けた、論理インターフェースのこと。  
例：FastEthernet0/0という物理I/Fがある場合、FastEthernet0/0.1、FastEthernet0/0.2と定義すれば作成できる。
  
VLAN間ルーティングを行いたい場合、VLANの数だけサブインターフェースを作成しIPアドレスを割り当てる。

## サブインターフェースを利用したVLANルーティングの設定
### 1. サブインターフェースの作成
`(config)# interface` *[interface-type]*.*[subinterface-number]*

### 2. カプセル化タイプとVLAN IDの設定
`(config-subif)# encapsulation` *[isl|dot1q]* *[vlan-id]* | *[native]*

### 3. IPアドレッシングの設定
`(config-subif)# ip address` *[ip-address]* *[subnet-mask]*