# ICMP (Internet Control Message Protocol)
IPプロトコルの「エラー通知」や「制御メッセージ」を転送するためのプロトコル。  
TCP/IPが実装されたコンピュータ間で、通信状態確認のために使用される。  
※OSI参照モデルのインターネット層で動作するプロトコル

## 1. ICMPの2種類のメッセージ
### 1-1. 問い合わせ(Query)
あるノードから特定のノードに対する通信状態を確認できる。  
例：**ping**や**traceroute**

### 1-2. エラー通知(Error)
ノード間の通信で経路途中でパケットが破棄されたりした場合に、その原因を送信元のノードにエラー通知する。

***

## 2. ping
ICMPプロトコルを使用したネットワークの診断プログラム。  
宛先となるノードと通信できるか(IPの到達性があるか)どうかを確認できる。

```bat
192.168.120.254 に ping を送信しています 32 バイトのデータ:
192.168.120.254 からの応答: バイト数 =32 時間 =4ms TTL=255
192.168.120.254 からの応答: バイト数 =32 時間 =3ms TTL=255
192.168.120.254 からの応答: バイト数 =32 時間 =2ms TTL=255
192.168.120.254 からの応答: バイト数 =32 時間 =5ms TTL=255
```
* バイト数：ICMPパケットのデータサイズ
* 時間    ：応答までに経過時間。
* TTL     ：何台のLayer3機器を通過できるのか。上記なら残り255台通過できる。

### 2-1. いろいろなエラー通知
1. Request timed out  
ICMPだけをブロックしている、経路途中にあるルータなどでICMP通信を制限している場合もある。  
*通信できないのはICMPの通信だけ*であり、TCP/IPにおける通信が問題ないこともある。  

>*column 1回目だけタイムアウトになる場合*  
    異なるNWと通信するとき、ホストはルータのMACアドレス情報が必要になるため、ルータに対し、ARPを実行する。  
    このARPを行なっている間にpingが失敗してしまうこともある。

2. Destination ne unreachable  
宛先ノードからの応答はないが、デフォルトゲートウェイまではパケットが通信している。  
ルーターの時点でルーティング情報がなく、宛先ネットワークに対してパケットを転送できないことが原因。

3. TTL expired in transit  
TTLの超過によるエラーをpingを実行したホストに伝達している。  
宛先に到達する前にLayer3機器の通過上限数を超えたため、パケットが破棄されている。  
→***設定ミスによるルーティングループが原因***であることがほとんど

***

## 3. traceroute
ICMPプロトコルを使用したネットワークの診断プログラム。  
* Windowsコマンド   **tracert**     ICMPプロトコル
* Ciscoコマンド     **traceroute**  UDP  
>> OSにより使用するプロトコルが異なるので、pingはOKだがtracerouteはNGと  
   結果が異なることもある。

あるホストから宛先のホストまで到達するためにどのNW経路を使用しているのかがわかり、  
結果、宛先ノードまでのネクストポップアドレスの一覧が表示される。  
>> ネクストポップアドレス：ルーティングで次にパケットを転送する隣接ルータのIPアドレス

### 3-1. trecertの仕組み
tracerouteではICMPパケットを送る際に、IPヘッダのTTLを「1」にする。  
1台目を通過した時点でパケットが破棄されるので、宛先の機器に到達するまでの経由ルータを認識できる。  
これをTTLを増やしながら宛先の機器にICMPエコー要求が到達するまで実行する。