# セキュアなネットワーク接続

## ■ ネットワークセキュリティグループ (NSG)

VNET上のAzureリソースが送受信するネットワークデータを選別するためのフィルター機能。  
複数のセキュリティ規則を決め、送信元/宛先IPアドレス、プロトコル、送信元/宛先ポート番号を指定可能。

***

## ■ アプリケーションセキュリティグループ (ASG)

Azure内の複数のVMを指定したい場合は、ASGを利用する。

ASGにVM等のリソースを一括でまとめて、そのASGに対してセキュリティ規則を割り当てる。

***

## ■ ユーザー定義ルート (UDR)

Azureでは、VNETに作成したサブネット間、VNET GWやExpressRouteで接続したオンプレミスのNW間のトラフィックが自動的にルーティングされる。  
VMからインターネットへの通信も可能のため、中継経路に関して通常は意識する必要はない。

ただし、DBサーバとの通信だけはセキュリティ管理サーバを必ず経由させたいといった要件なども往々にして存在する。

Azureではセキュリティ管理用サーバーを**仮想アプライアンス**として構成できる。一般にファイアウォールなどのNWサービスが実行されている仮想マシン。  
しかし、システムルートが自動的に生成され、各サブネットに自動的に割り当てられ、仮想アプライアンスを無視して、VM同士が直接通信をしてしまう。

そこで、**ユーザー定義ルート**を作成し、システムルートの動作を上書きすることができる。

***

## ■ Azure Firewall

VNETのサブネット間だけでなく、ピアリングやVPNゲートウェイを使うことで、ほかのVNETやオンプレミスとの通信も保護するファイアウォール。

### - **Azure Firewallができること**

- NSGが持つポート番号やIPアドレスを使った保護機能に加え、URL文字列を使った規則も指定可能
  
- 複数のVNETにまたがった規則を構成可能
  
- 脅威インテリジェンスDBを使った既知の攻撃パターンを防御可能
  
- AzureVMにパブリックIPを割り当てずにインターネット接続が可能
  
- Azure Firewallは**有償**

<br>

### - **一般的な使用シナリオ**

通常は、ハブとなるVNETに展開し、他のVNETはピアリング機能でこのハブと接続するよう構成する(**ハブアンドスポーク構成**)。  
この時のトラフィックがFirewallを通るようにUDRの構成も必要となる。

Azure Firewallでは以下のルールでトラフィックを制御する

- アプリケーションルール：
  FQDNを使った、アプリケーションごとのトラフィックの許可/不許可

- ネットワークルール：
  送信元/宛先アドレス、送信元/宛先ポート、プロトコルによるトラフィックの許可・不許可

> Tips：**脅威インテリジェンス**  
> 資産に対する既知および未知の脅威や危険に関するエビデンスに基づいた知識であり、この情報に基づいて、脅威や危険に対する攻撃対応の対応を決定することができる。

Azure Firewallはこのリストを脅威インテリジェンスを基に、リスクのある通信を自動的に遮断する(**脅威インテリジェンスベースのフィルタリング**)。

| Feature                | Description                                                                                |
| ---------------------- | ------------------------------------------------------------------------------------------ |
| 高可用性               | 対策しなくても一定の可用性が保証される。複数の可用性ゾーンにまたがれば99.99%の可用性を実現 |
| スケーラビリティ       | 弾力的にスケーリングするため、使用分のみのコスト                                           |
| 高度なフィルタリング   | ステートフルファイアウォール                                                               |
| Azure Monitoreとの連携 | ログ情報はAzure Monitorにも送信可能                                                        |

<br>

> Tips：**ステートフルファイアウォール**  
> 通信の開始や状態(ステート)を認識して、正当なパケットであるかどうかを文脈に基づいて判断する。

***

## ■ Azure DDoS保護

DDoS(Distributed Denial of Service：**分散型サービス拒否**)攻撃とは、多数のホストから一斉にアクセスすることでサーバーを動作不能にするもの。  
目的は愉快犯や営業妨害が多く、以下手順で行われるため、NSGで遮断できない。

1. インターネットに公開されたサーバーに対して、一見正当なアクセスをする

2. 正当なアクセスよりも圧倒的に高い頻度で、大量のデータを多くのホストから一斉に送り付ける

Azure DDoS保護サービスでは、NWを常に監視し、必要に応じてNW攻撃軽減策を取ることで保護している。

以下2つのレベルがあり、必要に応じて選択ることができる。

- Basic  
  Azureプラットフォームの一部として**無償**で提供され、自動的に有効になる(**無効にはできない**)。  
  NWトラフィックを常時監視し、一般的な攻撃に対して自動的に軽減策が適用される。

- Standard  
  アプリケーション利用状況に基づいた機械学習による防御ポリシーの調整や、ログ機能の拡充など、追加機能を提供する**有償**サービス。  
  利用するには「DDoS Protection Standrd」を明示的に有効にする必要がある。